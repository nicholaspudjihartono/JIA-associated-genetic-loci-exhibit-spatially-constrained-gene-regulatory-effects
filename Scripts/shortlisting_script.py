#!/usr/bin/env python

import argparse
import pandas
import statsmodels
from statsmodels.stats.multitest import fdrcorrection
pandas.options.mode.chained_assignment = None

#"risk_loci_dict" is a dictionary containing 71 JIA risk loci as the keys, and its LD partners as the values (see Supplementary Table 3 in the manuscript)

risk_loci_dict = {'rs6679677': ['rs6679677'],
 'rs72698115': ['rs73026617', 'rs111810442', 'rs72698115'],
 'rs4648881': ['rs10903110',
  'rs6682408',
  'rs6686594',
  'rs4649032',
  'rs4648881'],
 'rs1436238830': ['rs1436238830'],
 'rs12046117': ['rs10923228', 'rs12046117'],
 'rs2481065': ['rs60216416',
  'rs1209264',
  'rs11371032',
  'rs148299382',
  'rs2481065'],
 'rs72657048': ['rs4265380',
  'rs11249213',
  'rs7414934',
  'rs11249212',
  'rs7536201',
  'rs7528484',
  'rs6672420',
  'rs11311495',
  'rs4648889',
  'rs4649040',
  'rs4648890',
  'rs7550635',
  'rs7550552',
  'rs12407074',
  'rs7555518',
  'rs11249215',
  'rs10751776',
  'rs7529070',
  'rs10903119',
  'rs10903118',
  'rs7542147',
  'rs7542079',
  'rs7525903',
  'rs373993301',
  'rs7536848',
  'rs7523412',
  'rs7532198',
  'rs7523334',
  'rs7523328',
  'rs10751775',
  'rs72657048'],
 'rs2066363': ['rs2066363'],
 'rs10194635': ['rs6754937',
  'rs4851269',
  'rs1160544',
  'rs2309837',
  'rs10194635'],
 'rs45539732': ['rs45539732'],
 'rs10174238': ['rs7582694',
  'rs10181656',
  'rs8179673',
  'rs7574865',
  'rs7568275',
  'rs10174238'],
 'rs219158': ['rs219154',
  'rs219155',
  'rs219156',
  'rs219153',
  'rs219150',
  'rs219149',
  'rs219148',
  'rs219143',
  'rs219173',
  'rs219165',
  'rs219161',
  'rs219159',
  'rs219157',
  'rs219160',
  'rs219158'],
 'rs11889341': ['rs11889341'],
 'rs6434390': ['rs10202630', 'rs10166391', 'rs6434390'],
 'rs11692867': ['rs10496344',
  'rs12712068',
  'rs1821826',
  'rs1821827',
  'rs1370353',
  'rs2009094',
  'rs2009095',
  'rs11123813',
  'rs6707067',
  'rs4490209',
  'rs11123814',
  'rs13415583',
  'rs12992234',
  'rs7606455',
  'rs4452166',
  'rs4300851',
  'rs11899489',
  'rs13415465',
  'rs66733041',
  'rs4851253',
  'rs11681227',
  'rs13032454',
  'rs12712064',
  'rs4851252',
  'rs70940197',
  'rs11123809',
  'rs11900482',
  'rs13003982',
  'rs11123810',
  'rs11681966',
  'rs12987209',
  'rs12987212',
  'rs11690905',
  'rs11123812',
  'rs368755101',
  'rs4850921',
  'rs12712067',
  'rs11692867'],
 'rs953387': ['rs950176',
  'rs4954569',
  'rs61458349',
  'rs10179271',
  'rs6715785',
  'rs1401687',
  'rs10803550',
  'rs9941547',
  'rs2102896',
  'rs12473760',
  'rs12616955',
  'rs4954392',
  'rs4954567',
  'rs4954566',
  'rs2056297',
  'rs3078764',
  'rs4954568',
  'rs953387'],
 'rs79893749': ['rs112160248', 'rs368124274', 'rs3176953', 'rs79893749'],
 'rs79815064': ['rs58697594',
  'rs73833032',
  'rs73833033',
  'rs74433128',
  'rs76733709',
  'rs113676185',
  'rs79815064'],
 'rs7647909': ['rs7647909'],
 'rs1479924': ['rs1383048',
  'rs11724582',
  'rs6816311',
  'rs6847143',
  'rs6846978',
  'rs35077420',
  'rs1479924'],
 'rs62324212': ['rs62324212'],
 'rs7672495': ['rs7672495',
  'rs75292251',
  'rs75838132',
  'rs10022152',
  'rs74685329',
  'rs11933917'],
 'rs7660520': ['rs7660520'],
 'rs10213692': ['rs10213692',
  'rs6873385',
  'rs6859219',
  'rs10065637',
  'rs71624119'],
 'rs27293': ['rs27293',
  'rs38031',
  'rs27993',
  'rs31398',
  'rs1611102',
  'rs27294',
  'rs27295',
  'rs561318911',
  'rs27298',
  'rs38030',
  'rs27300',
  'rs39602',
  'rs27712',
  'rs38029',
  'rs27291',
  'rs27290',
  'rs27660'],
 'rs6894249': ['rs6894249', 'rs11745587'],
 'rs7731626': ['rs7731626'],
 'rs7775055': ['rs7775055',
  'rs146797694',
  'rs115341895',
  'rs2935907',
  'rs199923808',
  'rs115577932',
  'rs114218404',
  'rs115777056',
  'rs77537414',
  'rs74756176',
  'rs17427494',
  'rs112608098',
  'rs115842332',
  'rs114325417',
  'rs115262684',
  'rs116459302',
  'rs112317305',
  'rs141748883',
  'rs148781980',
  'rs1694113',
  'rs114801596',
  'rs79951097',
  'rs1794510',
  'rs113529604',
  'rs199526678',
  'rs76384124',
  'rs111335405',
  'rs113666293',
  'rs7774573',
  'rs7754496',
  'rs116147199',
  'rs140882479',
  'rs112574398',
  'rs149999552',
  'rs145250786',
  'rs114996593',
  'rs4713588',
  'rs112117693',
  'rs143607013',
  'rs146335245',
  'rs568935162',
  'rs112670480',
  'rs111903208',
  'rs113138578',
  'rs112535219',
  'rs112032264',
  'rs4713586',
  'rs112466823',
  'rs114744294'],
 'rs2395148': ['rs2395148', 'rs56269008', 'rs114928941'],
 'rs2614258': ['rs2614276',
  'rs2614257',
  'rs2746427',
  'rs2143793',
  'rs2614258',
  'rs2746431'],
 'rs4713573': ['rs4713573'],
 'rs73300638': ['rs528600345',
  'rs10260837',
  'rs10280937',
  'rs10281214',
  'rs7796417',
  'rs73089302',
  'rs10263857',
  'rs78693958',
  'rs6945537',
  'rs10276381',
  'rs73300638'],
 'rs6946509': ['rs28572733',
  'rs80156335',
  'rs542129111',
  'rs7793125',
  'rs4722180',
  'rs4722179',
  'rs35658589',
  'rs7804146',
  'rs2091115',
  'rs56061963',
  'rs35779989',
  'rs6946509',
  'rs10950916'],
 'rs7831697': ['rs7817006',
  'rs11784497',
  'rs13273964',
  'rs7827430',
  'rs57648530',
  'rs4471082',
  'rs4319134',
  'rs16906780',
  'rs7831697',
  'rs34983788',
  'rs34526548'],
 'rs7043505': ['rs4979466',
  'rs4979467',
  'rs2418322',
  'rs35625008',
  'rs7468552',
  'rs7043832',
  'rs7043766',
  'rs7043898',
  'rs7043505'],
 'rs7042370': ['rs7042370'],
 'rs10988542': ['rs10988542'],
 'rs2476491': ['rs2245675', 'rs2256852', 'rs2256774', 'rs2476491'],
 'rs7909519': ['rs12722495',
  'rs12722496',
  'rs12722508',
  'rs61839660',
  'rs7909519'],
 'rs7069750': ['rs2182408',
  'rs9658742',
  'rs9658720',
  'rs4244983',
  'rs1926192',
  'rs1926193',
  'rs1926194',
  'rs2148287',
  'rs4406737',
  'rs4406738',
  'rs11591675',
  'rs2147420',
  'rs7069750'],
 'rs2454539': ['rs2454546',
  'rs2252101',
  'rs1015620',
  'rs139765607',
  'rs2454541',
  'rs72801477',
  'rs201884788',
  'rs2454542',
  'rs2454543',
  'rs2447644',
  'rs1903981',
  'rs2454539'],
 'rs706778': ['rs706778', 'rs7072793', 'rs7073236', 'rs7096384', 'rs10795791'],
 'rs7082720': ['rs7082101',
  'rs7069841',
  'rs7910660',
  'rs7910825',
  'rs1926201',
  'rs1926200',
  'rs7914490',
  'rs1926197',
  'rs1800682',
  'rs1324551',
  'rs6586163',
  'rs6586164',
  'rs1926199',
  'rs7082720'],
 'rs6479891': ['rs4439410',
  'rs34916153',
  'rs7082090',
  'rs6479891',
  'rs9414780'],
 'rs12411988': ['rs4746195',
  'rs4469774',
  'rs61853642',
  'rs12412012',
  'rs61579729',
  'rs16918599',
  'rs16918600',
  'rs11812934',
  'rs16918601',
  'rs16918603',
  'rs4746201',
  'rs12411988'],
 'rs7100025': ['rs1926131', 'rs7905906', 'rs35506010', 'rs7100025'],
 'rs7127214': ['rs10466394',
  'rs11033552',
  'rs7130870',
  'rs10768207',
  'rs10836534',
  'rs2218565',
  'rs7127214',
  'rs3824946'],
 'rs7137828': ['rs7137828'],
 'rs10849448': ['rs2364481',
  'rs2364480',
  'rs10849448',
  'rs11064159',
  'rs10744706',
  'rs4301834'],
 'rs4766578': ['rs10774625', 'rs35350651', 'rs4766578'],
 'rs9532434': ['rs9532434',
  'rs7993214',
  'rs7986796',
  'rs9532430',
  'rs8002731',
  'rs12876235',
  'rs34270626',
  'rs9548932',
  'rs9532433',
  'rs12872801'],
 'rs34132030': ['rs9594770',
  'rs9525630',
  'rs9533127',
  'rs6561054',
  'rs4942131',
  'rs12876545',
  'rs2324919',
  'rs12876349',
  'rs67682123',
  'rs66749983',
  'rs34132030'],
 'rs12430303': ['rs4512994',
  'rs12430303',
  'rs9594766',
  'rs55868328',
  'rs9533110',
  'rs9594764',
  'rs141252748',
  'rs539445110',
  'rs1853573',
  'rs9594759',
  'rs1830790',
  'rs9533108',
  'rs9594763'],
 'rs11839053': ['rs11839053',
  'rs4772783',
  'rs60405790',
  'rs11843238',
  'rs11843540'],
 'rs3825568': ['rs2236262',
  'rs12889006',
  'rs35263356',
  'rs3825568',
  'rs4902647',
  'rs10711370',
  'rs12434551',
  'rs11158763',
  'rs12435329'],
 'rs1051533': ['rs1051533',
  'rs12147461',
  'rs2164627',
  'rs4902649',
  'rs72731554',
  'rs11851414',
  'rs11847049',
  'rs12147199',
  'rs60910661',
  'rs528401099'],
 'rs12719740': ['rs12719740',
  'rs12439188',
  'rs12901021',
  'rs12908695',
  'rs34133591',
  'rs12591872',
  'rs12595378'],
 'rs11074967': ['rs11074967',
  'rs11649678',
  'rs12597615',
  'rs138588459',
  'rs12931474'],
 'rs12232497': ['rs12950209',
  'rs567122494',
  'rs7359623',
  'rs12950743',
  'rs9906951',
  'rs9901146',
  'rs558669065',
  'rs12936409',
  'rs9908132',
  'rs2872507',
  'rs12941333',
  'rs12232498',
  'rs148094956',
  'rs62067029',
  'rs12103884',
  'rs12232497',
  'rs12939566',
  'rs12939565',
  'rs9904624',
  'rs11870965',
  'rs9903250',
  'rs4795398',
  'rs9905959',
  'rs11658278',
  'rs10852935',
  'rs10852936',
  'rs9891174',
  'rs36095411',
  'rs59716545',
  'rs12939457',
  'rs71152617',
  'rs34189114',
  'rs35736272',
  'rs1054609',
  'rs9907088',
  'rs36038753',
  'rs35569035',
  'rs9910826',
  'rs34074973',
  'rs200216139'],
 'rs149850873': ['rs149850873'],
 'rs2847293': ['rs34560559',
  'rs2014857',
  'rs888270',
  'rs67878610',
  'rs11663253',
  'rs34920518',
  'rs67518044',
  'rs9952991',
  'rs9952749',
  'rs2542151',
  'rs2542150',
  'rs2847280',
  'rs2542149',
  'rs2847278',
  'rs2847274',
  'rs2542148',
  'rs7237497',
  'rs2542147',
  'rs2847260',
  'rs2847293',
  'rs142342883',
  'rs9952753'],
 'rs9960807': ['rs9960807'],
 'rs34536443': ['rs34536443'],
 'rs62131887': ['rs62131887'],
 'rs2738774': ['rs2738774'],
 'rs8129030': ['rs66922517', 'rs9979383', 'rs8129030'],
 'rs2266959': ['rs11089620',
  'rs140491',
  'rs140489',
  'rs140492',
  'rs131665',
  'rs59391722',
  'rs140490',
  'rs140495',
  'rs2266961',
  'rs140498',
  'rs140499',
  'rs181359',
  'rs181360',
  'rs181361',
  'rs73166619',
  'rs5754166',
  'rs181362',
  'rs181363',
  'rs34977459',
  'rs2256609',
  'rs131664',
  'rs2266959',
  'rs138665726',
  'rs5754100',
  'rs5754102',
  'rs5754104',
  'rs131655',
  'rs131656',
  'rs5998509',
  'rs131657',
  'rs131658',
  'rs140488',
  'rs131659',
  'rs131660'],
 'rs2284033': ['rs228966',
  'rs2284033',
  'rs2543537',
  'rs228953',
  'rs228954',
  'rs228955',
  'rs228957',
  'rs228958',
  'rs228963',
  'rs71296616',
  'rs228965',
  'rs228960'],
 'rs12863738': ['rs12863738'],
 'rs4688011/rs11714843': ['rs62264483',
  'rs11714843',
  'rs59024323',
  'rs4688013',
  'rs4688011',
  'rs34000219',
  'rs2280670',
  'rs62264484',
  'rs11719448'],
 'rs4869313/rs4869314': ['rs2549782',
  'rs12655858',
  'rs10434708',
  'rs3734015',
  'rs112833506',
  'rs193993',
  'rs13189819',
  'rs4869313',
  'rs2549785',
  'rs11371784',
  'rs171647',
  'rs1559354',
  'rs185909589',
  'rs2548534',
  'rs2113190',
  'rs11750025',
  'rs72107567',
  'rs2548540',
  'rs56197090',
  'rs2549784',
  'rs549327836',
  'rs2549783',
  'rs12654015',
  'rs3849750',
  'rs4869312',
  'rs1559356',
  'rs11135484',
  'rs55770741',
  'rs200811208',
  'rs2548536',
  'rs2548538',
  'rs1559355',
  'rs6556943',
  'rs3096168',
  'rs11135482',
  'rs251342',
  'rs2548533',
  'rs536495759',
  'rs7721944',
  'rs2278019',
  'rs11135483',
  'rs2248374',
  'rs146022635',
  'rs2278018',
  'rs2161657',
  'rs11337784',
  'rs13167902',
  'rs4869314',
  'rs11375466',
  'rs3832367',
  'rs56321917',
  'rs1974871',
  'rs12516666',
  'rs5869736',
  'rs2287988',
  'rs2548537',
  'rs4869311',
  'rs6868302',
  'rs2303208',
  'rs10434709',
  'rs71226974',
  'rs2548535',
  'rs55691766',
  'rs3096167',
  'rs34701361',
  'rs1559357',
  'rs2042383',
  'rs1559359',
  'rs6556942',
  'rs12189125',
  'rs62377782',
  'rs2247650',
  'rs10707238']}


# The function below is to categorize each SNP by the risk locus it belongs to
# For example, "categorize_by_risk_locus('rs2549782')" will output "rs4869313/rs4869314" as the risk locus

def categorize_by_risk_locus(SNP):
    for risk_locus,LD_partners in risk_loci_dict.items():
        if SNP in LD_partners:
            return risk_locus
     
     
     
#Create the argument parser that takes in the CoDeS3D output files 'eqtls.txt' , 'snps.txt', and 'genes.txt'

parser = argparse.ArgumentParser(description='')
parser.add_argument("-e","--eqtls", type=argparse.FileType('r'), required=True, metavar = "eqtls.txt", help = "A tab-separated file containing eQTL-target gene pairs and its corresponding P-values, this is the CoDeS3D 'eqtls.txt' output file", dest = "eqtls")
parser.add_argument("-g", "--genes", type=argparse.FileType('r'), required=True, metavar="genes.txt", help = "A tab-separated file showing all the genes that are physically interacting with the input SNPs, this is the CoDeS3D 'genes.txt' output file", dest = "genes")
parser.add_argument("-s", "--snps", type=argparse.FileType('r'), required=True, metavar="snps.txt", help = "A tab-separated file showing all the SNPs are in the eQTL databases, this is the CoDeS3D 'snps.txt' output file", dest = "snps")
args = parser.parse_args()

# Read the input TSV files into a pandas DataFrame

eqtls = pandas.read_csv(args.eqtls, sep = '\t')
genes = pandas.read_csv(args.genes, sep = '\t')
snps = pandas.read_csv(args.snps, sep = '\t')


#At the current state, the "eqtls.txt" file does not contain rsID information for each SNPs, it only contain the variant ID. 
#In order to get the rsID information, we merge "eqtls.txt" with the ['snp','variant_id'] columns of "snps.txt". the ['snp'] column contains the rsID information. 

eqtls =  eqtls.merge(snps[['snp','variant_id']].drop_duplicates(),how='left',left_on='sid',right_on='variant_id')

#At the current state, the "eqtls.txt" file does not contain gene name information for each target gene, it only contain the the gene GENCODE ID. 
#In order to get the gene name information, we merge "eqtls.txt" with the ['gene','gencode_id'] columns of "genes.txt". the ['gene'] column contains the gene name information. 

eqtls = eqtls.merge(genes[['gene','gencode_id']].drop_duplicates(),how='left', left_on='pid', right_on='gencode_id')

#Remove redundant columns from 'eqtls' dataframe
eqtls = eqtls.drop(columns=['sid','pid'])


#Currently, the "eqtls" dataframe already has the SNP rsIDs and target gene name information
#However, the SNPs have not yet been grouped according to the risk locus it belongs to

     
#Now we create a new column called "risk_locus" which will contain the risk locus information of each SNP in the dataframe !

eqtls['risk_locus'] = ''
eqtls['risk_locus'] = eqtls['snp'].map(categorize_by_risk_locus)


#CHECKPOINT_1
print('checkpoint 1 reached')


#Now, we need to select the spatial eQTL with the lowest p-value for each risk locus-gene-tissue combinations as a representative of the risk locus' regulatory effect on a particular gene in a specific tissue/immune cell type prior to FDR correction.
#The rationale behind this approach is explained in Supplementary Figure 3 in the manuscript

eqtls_minimumP = eqtls.loc[eqtls.groupby(['tissue','risk_locus','gene'])['pval'].idxmin()]

#CHECKPOINT_2
print('checkpoint 2 reached')

#Now that we have the representative p-value of each hypothesis clusters (i.e., risk locus-gene-tissue combinations)
#We want to do Benjamini-Hochberg FDR correction on the set of representative hypotheses individually in each tissues
#First, we make an empty column called "adj_pval_shortlisted"
eqtls_minimumP['adj_pval_shortlisted'] = ''

#Lets now fill the ['adj_pval_shortlisted'] column with the appropriate value

for x in list(eqtls_minimumP['tissue'].unique()):
    subset = eqtls_minimumP[eqtls_minimumP['tissue'] == x]
    fdr = fdrcorrection(subset['pval'])
    subset['adj_pval_shortlisted']=fdr[1]
    eqtls_minimumP.update(subset)
    
#CHECKPOINT_3
print('checkpoint 3 reached')

#Finally.. extract the shortlisted significant eqtls (i.e., rows that have 'adj_pval_shortlisted' less than or equal to 0.05)
significant_eqtls_shortlisted = eqtls_minimumP[eqtls_minimumP['adj_pval_shortlisted'] <= 0.05]

#CHECKPOINT_4
print('checkpoint 4 reached')

#Re-order the columns for easier reading

significant_eqtls_shortlisted = significant_eqtls_shortlisted.reindex(columns=['risk_locus','variant_id','snp','sid_chr','sid_pos','gencode_id','gene','adj_pval_shortlisted','adj_pval','pval','b','b_se','maf','tissue'])

#CHECKPOINT_5
print('checkpoint 5 reached')

#Save as a csv file
significant_eqtls_shortlisted.to_csv('significant_eqtls_shortlisted.txt', sep='\t', index=False)

#CHECKPOINT_6
print('checkpoint 6 reached ... aka FINISHED')



